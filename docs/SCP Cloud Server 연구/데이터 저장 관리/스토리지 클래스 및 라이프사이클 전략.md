# 스토리지 클래스 및 라이프사이클 전략

## 목적

- S3 스토리지 클래스를 이해하고, SPC Cloud Server 데이터(원본/프리뷰/썸네일/임시/아카이브)에 대한 비용 최적화 저장·이동 정책을 정의한다.

## 스토리지 클래스 비교(요지)

- 비용 수치는 리전·사용량·시점에 따라 달라질 수 있으므로, 아래는 S3 Standard 대비 상대값(대략)으로 표기한다.

| 클래스                     | 용도/특징                                 | 저장비용(표준 대비) | 조회비용        | 조회속도      | 최소 보관기간 |
| -------------------------- | ----------------------------------------- | ------------------- | --------------- | ------------- | ------------- |
| Standard                   | 자주 접근, 기본 클래스                    | 100%                | 낮음            | 즉시          | 없음          |
| Intelligent-Tiering        | 접근 패턴 자동 최적화, 모니터링 비용 소액 | 90~100% + 모니터링  | 낮음~중간       | 즉시          | 없음          |
| Standard-IA                | 가끔 접근, 즉시 조회 필요                 | 50~60%              | 있음(GB/요청당) | 즉시          | 30일          |
| Glacier Flexible Retrieval | 장기 보관, 드물게 조회                    | 10~20%              | 높음(복구 비용) | 수분~수시간   | 90일          |
| Glacier Deep Archive       | 최장기 보관, 거의 미조회                  | 4~5%                | 높음(복구 비용) | 수시간~48시간 | 180일         |

참고

- Intelligent-Tiering은 객체 모니터링/자동 전환 비용이 별도로 과금된다.
- IA/Glacier 계열은 조회 시 복구/전송 비용이 추가되며, 최소 보관기간 이전 삭제 시 비용이 발생한다.

## 데이터 유형별 권장 저장/이동 정책

- 공통: 객체에 `clinicId`, `patientId`, `type(original|preview|thumb|temp|archive)` 등의 태그를 부여해 라이프사이클 규칙을 유형별로 적용한다.

1. 원본 이미지/CT(DICOM 등)

- 업로드: Standard (즉시 접근성과 내구성 확보)
- 30일 경과: Standard-IA 이동
- 180일 경과: Glacier Flexible Retrieval 이동(규제/법적 보존 예외는 제외 태그 적용)
- 조회/복구: 필요 시 일시 복구(restore) 후 서명 URL 제공

2. 프리뷰(JPEG2000 등)

- 업로드: Intelligent-Tiering (초기 빈번-비빈번 혼재, 자동 최적화)
- 60일 경과: IA로 이동(접근 감소 시)
- 365일 경과: 필요 없으면 만료 삭제 또는 Glacier 이동(서비스 정책에 따름)

3. 썸네일

- 소용량/자주 조회: Standard 또는 Intelligent-Tiering(모니터링 비용 대비 크기 작아 비용 영향 미미)
- 장기 미사용 시: IA 이동 고려(필요 시)

4. 임시/중간 산출물(temp, 업로드 버퍼 등)

- 업로드: Standard
- 7~30일 내 만료 삭제(Expiration) 규칙 적용

5. 아카이브(법적/감사 목적의 장기 보존)

- 초기 적재: Glacier Flexible 또는 Deep Archive(조회 요구시간 기준 선택)
- 복구 절차: 복구 소요시간/비용 SLA를 문서화하고 운영 절차에 반영

## 리전/클리닉 분리 고려사항

- 리전별 성능·규제 요구 시: 리전별 버킷/라이프사이클을 동일 정책으로 운영
- 병원/테넌트 분리: `clinicId` 프리픽스·태그로 정책 분리, 필요 시 크로스어카운트/리전 복제(S3 Replication) 적용

## 예시: 라이프사이클 규칙(JSON 스니펫)

```json
{
  "Rules": [
    {
      "ID": "original-tiering",
      "Filter": { "Tag": { "Key": "type", "Value": "original" } },
      "Status": "Enabled",
      "Transitions": [
        { "Days": 30, "StorageClass": "STANDARD_IA" },
        { "Days": 180, "StorageClass": "GLACIER" }
      ],
      "NoncurrentVersionTransitions": [],
      "Expiration": { "ExpiredObjectDeleteMarker": false }
    },
    {
      "ID": "preview-int-tiering",
      "Filter": { "Tag": { "Key": "type", "Value": "preview" } },
      "Status": "Enabled",
      "Transitions": [
        { "Days": 0, "StorageClass": "INTELLIGENT_TIERING" },
        { "Days": 60, "StorageClass": "STANDARD_IA" }
      ],
      "Expiration": { "Days": 365 }
    },
    {
      "ID": "thumbnail-keep-or-ia",
      "Filter": { "Tag": { "Key": "type", "Value": "thumb" } },
    "Status": "Enabled",
      "Transitions": [{ "Days": 90, "StorageClass": "STANDARD_IA" }]
    },
    {
      "ID": "temp-expire",
      "Filter": { "Tag": { "Key": "type", "Value": "temp" } },
      "Status": "Enabled",
      "Expiration": { "Days": 14 }
    }
  ]
}
```

주의

- Deep Archive가 필요하면 `GLACIER_DEEP_ARCHIVE`로 교체하고 최소 보관기간을 고려해 일수 조정.
- 프리뷰/썸네일은 서비스 UX에 미치는 영향이 크므로 삭제 정책은 신중히 설정.

## 운영 팁

- CloudWatch Storage Lens/Cost Explorer로 클래스별 비용 모니터링 및 규칙 튜닝
- 객체 태깅 자동화: 업로드 경로·메타데이터 기반 Lambda로 태그 일관 부여
- 복구(restore) 비용/시간이 발생하므로, 아카이브 대상 선정 시 재사용 가능성을 KPI로 관리

## 결론

- 기본 원칙: "자주 쓰는 데이터는 Standard/Intelligent-Tiering, 드물게 쓰는 데이터는 IA/Glacier"로 자동화.
- 본 전략은 비용·성능 균형을 목표로 하며, 초기 운영 데이터(접근 패턴)를 기반으로 전환 임계값(일수)을 조정한다.
