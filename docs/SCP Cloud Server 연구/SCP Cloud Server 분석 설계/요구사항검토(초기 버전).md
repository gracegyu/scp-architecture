# 요구사항 검토 (초기 버전)

## 1. 전제조건

- **SCP 서비스는 인터넷 연결 환경에서만 동작한다.**

## 2. Top level Diagram

## 3. 서비스 구성 (TBD: Diagram)

- **One-ID Server (AWS, Hosting 모두 지원)**

  - **Authentication**
    - User Credential (login for user)
    - Client Credential (for API)
    - API service
    - 조직 (Organization, 클리닉, 기공소)
    - 역할 (Role)
  - **Authorization**
    - Resource 서버에서 각각 구현?

- **SC Server (OnPremise)**

  - DB, Storage

- **SC Server Cloud (AWS, Hosting 모두 지원)**

  - DB Server
  - Storage Server

- **Clients**

  - **Simple Web viewer**
    - Edit?
  - 기공소?
  - 원격 판독? 리뷰?
  - Ez Series?

- **Back Office**

  - VT에서 One-ID Server 전체를 관리하는 툴
  - **기능**
    - Id, 조직, 역할, Application 관리
    - 통계
    - TBD

- **ID, 조직, 역할 관리 서비스**

  - 각 병원 또는 개인이 아래 정보를 관리하는 툴
    - 로그인 관리
    - Id, 조직, 역할 관리
    - 커스트마이징

- **Auth SDK**
  - **Auth0의 Client Sample code**
    - github : https://github.com/orgs/auth0-samples/repositories
    - 121가지를 제공함
  - **For SPA, Native, Web, Shell script, iOS, Android, UWP, language별 library for package**
    - Github : https://github.com/orgs/auth0/repositories 중 일부

## 4. 기능 설명 (Draft)

- **Open ID Server**

  - **기능**
    - 통합 사용자 계정 관리
    - 조직과 사용자 관리
      - 조직이 없는 사용자도 존재한다.
    - Role 관리
    - 조직, 사용자, Role 별 권한 부여
  - **권한**
    - 서비스 사용 권한 (서비스 전체 및 기능)
    - 데이터 접근 권한
      - **단위**
        - 환자 정보
        - 영상 정보
          - Storage 전체
          - 개별 데이터
      - **권한 구분**
        - Read only
        - Read write

- **SC Server Cloud**
  - DB Server
  - Storage Server

## 5. Questions

- **Authorization 기능은 어디에 둘까?**

  - **1안. 각 Resource 서버마다 둔다.**
  - **2안. VT One-ID 서버가 기능을 담당한다. (추후 제공 v2)**
    - VT One-ID 서버가 기능을 제공해도 API만 제공 가능하고, 각 Resource 서버에서 GUI를 구현해야 한다.
    - 기능: VT One-ID 서버
    - GUI: 각 Resource 서버
    - Storage 서버의 Authorization은 영상마다 권한을 다르게 부여할 수 있으므로 VT One-ID 서버에서 제공하기는 어렵다.
  - **Auth0는 Authorization 기능을 설정할 수 있다.**
    - API 기능에서 제공
    - MachineToMachine만 제공한다.
      - User Authorization은 제공하지 않는다.

- **로그아웃 할 경우**

  - **해당 Access token은 추후 유효한가?**
    - **Auth0 테스트 결과**
      - 로그아웃을 해도 해당 Access token은 무효화 되지 않는다. 사용할 수 있다.
    - **TBD**: 로그아웃을 하면 Access token은 무효화 해야 하는 것 사용할 수 없도록 해야 하는 것 아닌가? VT One-ID는 어떻게 해야 할까? 하나로 결정해야 할까? 설정할 수 있어야 할까?

- **VT One-ID 서버도 MachineToMachine authentication을 지원해야 할까?**

  - **지원해야 한다.**
  - TBD (추후 제공 v2)

- **조직(Organization)/역할(Role) 관리**

| 구분                   | Auth0                                        | VT One-ID 서비스            |
| ---------------------- | -------------------------------------------- | --------------------------- |
| 관리 주체              | 전체 Admin                                   | 각 조직 Admin               |
| 조직 할당              | 가입 후 Admin이 설정                         | 가입시 결정? 어떻게?        |
| 역할 할당              | 가입 후 Admin이 설정                         | 가입 후 조직 마스터가 한다? |
| 조직/역할 관리         | Admin이 관리                                 | 조직 마스터가 관리          |
| 역할 복수 할당 (0 ~ N) | 가능                                         | 가능?                       |
| 복수 조직 할당 (0 ~ N) | 가능                                         | 가능?                       |
| 조직 추가              | Admin                                        | Admin? 조직 마스터?         |
| 조직 삭제              | Admin                                        | Admin? 조직 마스터?         |
| 조직 관리              | Admin                                        | 조직 마스터?                |
| 역할 추가              | Admin                                        | Admin? 조직 마스터?         |
| 역할 관리              | Admin                                        | 조직 마스터?                |
| 조직별 커스터마이징    | 로고이미지<br>기본색<br>바탕색<br>메타데이터 | TBD                         |

- **조직별 마스터 인원수?**
  - 1명 or 여러명

<!-- -->

## 6. 기술 검토 항목

- **OIDC spec 문서**
  - https://openid.net/developers/specs/

## 7. TBD

- **세션 관리**

  - 로그아웃 시 토큰 무효화를 위해서는 세션관리가 필요하다.
    - Auth0에서는 로그아웃해도 토큰이 무효화 되지 않는다. 이 토큰을 이용해서 여전히 인증이 된다.

- **자동 로그인 (for Web)**

  - 쿠키를 이용해야 한다.
  - **Auth0의 쿠키**
    - **dev-sbirmspmgs3x8r0p.us.auth0.com**
      - auth0 : `s%3AKzRnUdcj48iEL30s_r0nxhorbeZp90tq.XMsgN18Opqef6x%2BNwofwMOdHW1MuIgZzG8jNl5rm5Pg`
      - did : `s%3Av0%3A01f156f0-a068-11ed-8631-c7691fe422ae%3A7ffe6f884446bc5e82cd6e4b3a65555676b2b58236d2e1103b6025a20019bbeb%3Abb98edb89a21821712f5cc2cca8e4c74744e3e651151fef5ded79457a2f82d31%3Ac800c55f2948b123a1a27771fdfb847d3a4814503150462e2bb9dffc4b742794.UFPC%2FECLp5Znjk8fpk0f4W2I7J%2F%2BEoVjOA%2F3T%2FYNs%2FY`
    - **auth0.com**
      - OptanonConsent : `isGpcEnabled=0&datestamp=Fri+Feb+10+2023+08%3A02%3A32+GMT%2B0900+(Korean+Standard+Time)&version=6.23.0&isIABGlobal=false&hosts=&landingPath=NotLandingPage&groups=1%3A1%2C2%3A1%2C3%3A1%2C4%3A1&AwaitingReconsent=false`
      - googtrans : `/en/ko`
      - googtransopt : `os=1`
      - ajs_anonymous_id : `%220e33ce8d-d8ae-4431-a59a-e5b7c36b3923%22`
      - ajs_user_id : `%22auth0%7C63c788915da4e791a0987ded%22`
      - docs_current_tenant : `dev-sbirmspmgs3x8r0p%40pus4`
    - 자동 로그인에 사용되나?

- **동시 로그인 금지 (지원안함)**

  - 세션 관리 필요
  - 은행등의 앱에서는 제공하는 기능이지만 우리는 제공할 필요가 없다.
  - 의료기기 인증, Cybersecurity 등의 요구사항으로 인해 지원해야 할 수 있다.
  - 아예 동시 로그인을 금지하는 것은 기술적으로 어렵고, 위치 기반 등으로 경고하는 것을 지원하는 것은 고려해볼 수 있겠다.

- **강제 로그아웃 (지원안함)**

  - 다른 곳에서 다시 로그인시 이전 로그인 강제 로그아웃?
  - Noti를 해야 하므로 어렵다.
  - 은행등의 앱에서는 제공하는 기능이지만 우리는 제공할 필요가 없다.

- **CORS**

  - Web을 지원하기 위해서는 CORS를 제공해야 한다.

- **2단계 인증 지원**
