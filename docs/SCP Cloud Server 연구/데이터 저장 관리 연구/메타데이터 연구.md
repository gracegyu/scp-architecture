# 메타데이터 연구

## 목적/범위

- 클라우드 환경에서 치과 영상(CT 포함)의 메타데이터 저장·조회·동시편집·공유(Share)·권한 관리를 안정적·확장 가능하게 설계한다.

## 현재 현황(로컬)

- 사이드카 파일 `.prj` (XML)로 원본과 동일 폴더/이름으로 보관.
- 장점: 단순/휴대성. 한계: 동시편집 충돌, 검색/필터 취약, 부분 업데이트 불가, 권한/버전 관리 어려움.

## 요구사항 요약

- 빠른 조회/검색(Clinic, Study/Series/Instance, Tag, 날짜, 공유 상태 등)
- 동시편집 충돌 방지(버전, 조건부 업데이트)
- 공유(Share) 권한 모델과 연동(만료/링크/대상)
- 부분 업데이트(뷰 상태, 주석 등)와 이력/감사
- 오프라인/내보내기 호환(사이드카 스냅샷)

## 후보안 비교

1. S3 사이드카 파일만(XML/JSON)
   - 장점: 단순/저비용. 단점: 경합/검색/권한/버전 관리 취약.
2. Aurora(RDB)
   - 장점: 트랜잭션/조인/복잡쿼리 강점. 단점: 운영/스케일 비용, 스키마 변경 부담.
3. DynamoDB(NoSQL)
   - 장점: 대규모 확장/낮은 지연/조건부 업데이트/서버리스. 단점: 조인 불가, 설계 주도 필요.
4. 하이브리드(DynamoDB + S3 JSON)
   - 장점: 핵심 인덱스/권한은 DB, 대용량 주석은 S3에 Blob로 분리. 비용/확장/동시편집/검색 균형.

## 결론(채택)

- "DynamoDB 단일 저장(정본) + 선택적 JSON 사이드카 Export".
  - DynamoDB: 정본/인덱스/권한/버전/이력 최소 필드 유지(아이템 400KB 한도 내 설계).
  - 사이드카: 데스크톱/오프라인/내보내기 시 동일 이름 JSON 생성(옵션). 정본은 항상 DynamoDB.

### DB 저장 전략(환자/시스템/사용자)

- 환자/클리닉/유저 등 마스터 데이터: RDBMS(Aurora PostgreSQL) 유지
  - 이유: 트랜잭션, 조인/리포트, 규제/감사를 위한 정합성 유리
- 이미지 메타데이터(시스템+사용자): DynamoDB 단일 테이블
  - 이유: 고동시성/낮은 지연, 조건부 업데이트로 충돌 방지, 유연 스키마
- 참고: DynamoDB는 SQL JOIN이 없으므로 비정규화와 GSI로 조회 패턴을 설계한다

## 데이터 모델 초안

- 파티션키(PK): `clinicId#studyId` 또는 `clinicId#objectKey`
- 정렬키(SK): `seriesId#instanceId#variant`
- GSI 예: `GSI1: patientId/date`, `GSI2: tag`, `GSI3: shared`
- 핵심 필드: `clinicId, ownerUserId, objectKey, type(CT/2D), viewerState{rotation,zoom,window}, annotations[], share{targets,expiresAt}, version, updatedAt`

## 동시편집/버전

- Optimistic Locking: `version` 조건부 갱신(ConditionalExpression).
- 충돌 시 서버가 병합 정책 또는 클라이언트 재시도 전략 반환.

## API 스케치

- GET/PUT `/metadata/{objectKey}` (DB 우선, Blob 참조 반환)
- PATCH `/metadata/{objectKey}/viewer-state` (부분 업데이트)
- PUT `/metadata/{objectKey}/annotations` (S3에 저장 후 DB에 참조 반영)
- POST `/shares` (대상/만료 등록), 검사 시 Authorization 서비스에서 검증

## 업로드/동기화 플로우

1. S3 ObjectCreated → Lambda: 기존 `.prj`(XML) 발견 시 JSON 변환
2. DynamoDB 정본 업서트(조건부, version 체크)
3. (옵션) 사이드카 JSON Export 생성(S3 동일 prefix/이름)
4. 알림/이벤트로 클라이언트 진행률/상태 업데이트

## 보안/권한

- JWT의 `clinicId`를 기본 범위 권한으로 활용.
- 공유 리소스는 Authorization 서비스가 DB 기준으로 ACL/링크/만료 검증.

## 마이그레이션

- 신규는 JSON만 생성. 기존 XML은 배치 변환(병렬 Lambda) → S3(JSON) + DB 업서트.

## 오픈 이슈

- 정밀 키 설계 선택(Aurora 병용 필요성?), 대용량 주석 분할 전략, 뷰 상태 표준 스키마 합의.
