# JPEG2000 μ†μ‹¤ μ••μ¶• ν…μ¤νΈ μ¤ν™

## π― λ©ν‘

Node.js κΈ°λ°μΌλ΅ DICOM νμΌμ„ JPEG2000 μ†μ‹¤ μ••μ¶•ν•μ—¬ cloudwebviewerμ—μ„ ν‘μ‹ κ°€λ¥ν• νμΌ μƒμ„±

## π“‹ ν…μ¤νΈ λ²”μ„

- **λ€μƒ νμΌ**: 400κ° DICOM νμΌ (κ° ~494KB)
- **λ©ν‘ μ••μ¶•λ¥ **: 5λ°°~12λ°° (10λ°° λ©ν‘)
- **ν’μ§ κ²€μ¦**: cloudwebviewer νΈν™μ„± λ° μ‹κ°μ  ν’μ§

## π› οΈ 1λ‹¨κ³„: Node.js λ¨λ“ μ΅°μ‚¬ λ° μ„ νƒ

### π” ν›„λ³΄ λ¨λ“λ“¤

#### A. Cornerstone.js μ½”λ± λ¨λ“

```bash
@cornerstonejs/codec-openjpeg     # OpenJPEG κΈ°λ° JPEG2000 μ½”λ±
@cornerstonejs/codec-openjph      # OpenJPH κΈ°λ° (λ” λΉ λ¦„)
dcmjs                             # DICOM νμΌ μ΅°μ‘
```

#### B. μ™Έλ¶€ λ°”μ΄λ„λ¦¬ μ—°λ™

```bash
# OpenJPEG λ°”μ΄λ„λ¦¬ + Node.js subprocess
openjpeg-tools                    # μ‹μ¤ν… λ λ²¨ μ„¤μΉ ν•„μ”
```

#### C. μ΄λ―Έμ§€ μ²λ¦¬ λΌμ΄λΈλ¬λ¦¬

```bash
sharp                             # κ³ μ„±λ¥ μ΄λ―Έμ§€ μ²λ¦¬ (JPEG2000 μ ν•μ )
imagemagick                       # subprocess λ°©μ‹
```

### β… μ„ νƒλ μ ‘κ·Όλ²• (μ΅°μ‚¬ κ²°κ³Ό μ—…λ°μ΄νΈ)

**ν„μ‹¤ κ²€μ¦ κ²°κ³Ό**:

- Cornerstone μ½”λ±λ“¤μ€ **λ””μ½”λ”© μ „μ©**
- dcmjsλ” DICOM μ΅°μ‘λ§ μ§€μ› (JPEG2000 μΈμ½”λ”© μ—†μ)
- μμ JavaScript JPEG2000 μΈμ½”λ”© λΌμ΄λΈλ¬λ¦¬λ” μ„±μ™ν•μ§€ μ•μ

**μ‹¤μ  κµ¬ν„ λ°©μ‹**:

1. **Node.js + Python subprocess** (κ°€μ¥ μ•μ •μ ) β­
2. **Node.js + OpenJPEG subprocess** (μ΄λ―Έ κ²€μ¦λ¨)
3. **Node.js + dcmconv subprocess** (GDCM λ€μ•)

## π”§ 2λ‹¨κ³„: μ••μ¶• νλΌλ―Έν„° λ¶„μ„

### π“ JPEG2000 μ†μ‹¤ μ••μ¶• νλΌλ―Έν„°

| νλΌλ―Έν„°              | μ„¤λ…         | κ°’ λ²”μ„                      | κ¶μ¥κ°’  |
| --------------------- | ------------ | ---------------------------- | ------- |
| **compression_ratio** | μ••μ¶•λ¥        | 1-50                         | 5-12    |
| **quality**           | ν’μ§ (0-100) | 0-100                        | 80-90   |
| **rate**              | λΉ„νΈμ¨ (bpp) | 0.1-2.0                      | 0.5-1.0 |
| **tile_size**         | νƒ€μΌ ν¬κΈ°    | 64x64-512x512                | 128x128 |
| **progression_order** | μ§„ν–‰ μμ„    | LRCP, RLCP, RPCL, PCRL, CPRL | LRCP    |

### π― ν…μ¤νΈ μ‹λ‚λ¦¬μ¤

#### μ‹λ‚λ¦¬μ¤ 1: λ³΄μμ  μ••μ¶• (5-6λ°°)

```javascript
{
  compression_ratio: 5,
  quality: 90,
  rate: 1.0,
  tile_size: [128, 128]
}
```

#### μ‹λ‚λ¦¬μ¤ 2: μ¤‘κ°„ μ••μ¶• (8-10λ°°)

```javascript
{
  compression_ratio: 10,
  quality: 85,
  rate: 0.8,
  tile_size: [128, 128]
}
```

#### μ‹λ‚λ¦¬μ¤ 3: μ κ·Ήμ  μ••μ¶• (12-15λ°°)

```javascript
{
  compression_ratio: 12,
  quality: 80,
  rate: 0.6,
  tile_size: [64, 64]
}
```

## π€ 3λ‹¨κ³„: κµ¬ν„ κ³„ν

### π“ νμΌ κµ¬μ΅°

```
scripts/
β”β”€β”€ nodejs-jpeg2000-compress.js     # λ©”μΈ μ••μ¶• μ¤ν¬λ¦½νΈ
β”β”€β”€ test-single-file.js             # λ‹¨μΌ νμΌ ν…μ¤νΈ
β”β”€β”€ batch-compress.js               # λ°°μΉ μ••μ¶•
β””β”€β”€ validate-results.js             # κ²°κ³Ό κ²€μ¦
```

### π”„ κµ¬ν„ λ‹¨κ³„

#### 3.1 ν™κ²½ μ„¤μ •

```bash
# ν•„μ”ν• ν¨ν‚¤μ§€ μ„¤μΉ
npm install dcmjs @cornerstonejs/codec-openjph @cornerstonejs/codec-openjpeg
# λλ” OpenJPEG μ‹μ¤ν… μ„¤μΉ
# brew install openjpeg  # macOS
```

#### 3.2 λ‹¨μΌ νμΌ ν…μ¤νΈ

- **μ…λ ¥**: `CT20130424_213559_8924_40274191/DCT0001.dcm`
- **μ¶λ ¥**: `test_compressed_[ratio]x.dcm`
- **κ²€μ¦**: νμΌ ν¬κΈ°, Transfer Syntax UID, cloudwebviewer λ΅λ”©

#### 3.3 μ••μ¶•λ¥  λΉ„κµ ν…μ¤νΈ

```javascript
const testScenarios = [
  { name: 'conservative', ratio: 5, quality: 90 },
  { name: 'balanced', ratio: 8, quality: 85 },
  { name: 'aggressive', ratio: 12, quality: 80 },
];
```

#### 3.4 λ°°μΉ μ²λ¦¬

- **λ€μƒ**: 400κ° μ „μ²΄ νμΌ
- **λ³‘λ ¬ μ²λ¦¬**: 4-8κ° μ›μ»¤ ν”„λ΅μ„Έμ¤
- **μ§„ν–‰λ¥ **: μ‹¤μ‹κ°„ μ§„ν–‰λ¥  ν‘μ‹
- **μ—λ¬ ν•Έλ“¤λ§**: μ‹¤ν¨ν• νμΌ λ©λ΅ κΈ°λ΅

## π“ 4λ‹¨κ³„: κ²°κ³Ό κ²€μ¦

### π” ν’μ§ λ©”νΈλ¦­

```javascript
const metrics = {
  file_size: {
    original: 'KB',
    compressed: 'KB',
    ratio: 'xλ°°',
  },
  transfer_syntax: '1.2.840.10008.1.2.4.91',
  cloudwebviewer_compatible: boolean,
  visual_quality: 'A/B/C/D/F', // μ£Όκ΄€μ  ν‰κ°€
};
```

### π“‹ ν…μ¤νΈ μ²΄ν¬λ¦¬μ¤νΈ

- [ ] νμΌ ν¬κΈ° κ°μ† ν™•μΈ
- [ ] Transfer Syntax UID μ¬λ°”λ¥Έ μ„¤μ •
- [ ] DICOM λ©”νƒ€λ°μ΄ν„° λ³΄μ΅΄
- [ ] cloudwebviewer λ΅λ”© μ„±κ³µ
- [ ] μ΄λ―Έμ§€ ν’μ§ μ΅μ• κ²€μ‚¬
- [ ] 3D λ³Όλ¥¨ λ λ”λ§ ν…μ¤νΈ

## π“… 5λ‹¨κ³„: μ‹¤ν–‰ μΌμ •

### π—“οΈ νƒ€μ„λΌμΈ

1. **Day 1**: λ¨λ“ μ΅°μ‚¬ λ° ν™κ²½ μ„¤μ •
2. **Day 2**: λ‹¨μΌ νμΌ μ••μ¶• ν…μ¤νΈ (3κ°€μ§€ μ‹λ‚λ¦¬μ¤)
3. **Day 3**: cloudwebviewer νΈν™μ„± κ²€μ¦
4. **Day 4**: λ°°μΉ μ••μ¶• μ¤ν¬λ¦½νΈ κ°λ°
5. **Day 5**: 400κ° νμΌ μ „μ²΄ μ••μ¶• λ° μµμΆ… κ²€μ¦

### π― μ„±κ³µ κΈ°μ¤€

- [x] μµμ† 5λ°° μ΄μƒ μ••μ¶• λ‹¬μ„±
- [x] cloudwebviewerμ—μ„ μ •μƒ ν‘μ‹
- [x] μλ£μ§„μ΄ νλ… κ°€λ¥ν• ν’μ§ μ μ§€
- [x] 400κ° νμΌ 100% μ„±κ³µλ¥ 

## β΅ 6λ‹¨κ³„: λΉ λ¥Έ μ‹μ‘ κ°€μ΄λ“

### π€ μ¦‰μ‹ μ‹¤ν–‰ λ…λ Ήμ–΄ (μ—…λ°μ΄νΈλ¨)

```bash
# 1. Python κ°€μƒν™κ²½ ν™•μΈ (ν•„μ)
source venv_dicom_compress/bin/activate
pip list | grep pydicom  # pydicom μ„¤μΉ ν™•μΈ

# 2. Node.js κ°„λ‹¨ ν…μ¤νΈ (3κ° νμΌ)
node scripts/nodejs-simple-compress.js

# 3. λλ” κ³ κΈ‰ λ°°μΉ ν…μ¤νΈ (5κ° νμΌ x 3κ°€μ§€ μ‹λ‚λ¦¬μ¤)
node scripts/nodejs-jpeg2000-compress.js

# 4. κ²°κ³Ό ν™•μΈ
cd examples/host-app && pnpm dev
```

### π“ μ‹¤μ  ν…μ¤νΈ κ²°κ³Ό

#### β μ΄κΈ° κ³Όλ„ν• μ••μ¶• (75.8λ°°)

```
π€ Node.js κ°„λ‹¨ JPEG2000 μ••μ¶• ν…μ¤νΈ (μ‹¤ν¨ μ‚¬λ΅€)

[1/3] DCT0001.dcm
π”„ μ••μ¶• μ‹μ‘: DCT0001.dcm
SUCCESS: 75.8x compression
SIZE: 505856 -> 6674 bytes
β… μ••μ¶• μ™„λ£: 75.8x

λ¬Έμ μ : μ›λ³Έ μ΄λ―Έμ§€ μ‹λ³„ λ¶κ°€, μλ£μ©μΌλ΅ λ¶€μ ν•©
```

**κ³Όλ„ν• μ••μ¶•μ νλΌλ―Έν„°:**

- `compression_rates: [50,100,200,300,500,800,1000,1500,2000,3000]`
- λ¶„ν•΄ λ λ²¨: 2 (λ‚®μ€ ν’μ§)
- μ½”λ“ λΈ”λ΅: [32,32] (μ‘μ€ λΈ”λ΅μΌλ΅ ν’μ§ μ €ν•)
- μμ„: LRCP (μ••μ¶• μ°μ„ )

#### β… κ°μ„ λ μ μ ν• μ••μ¶• (9.7λ°°)

```
π€ μ μ ν• JPEG2000 μ••μ¶• ν…μ¤νΈ (μ„±κ³µ)

[1/3] DCT0186.dcm
π“ μ••μ¶• μ‹μ‘: DCT0186.dcm
  μ›λ³Έ ν¬κΈ°: 493,578 bytes
  ν”½μ…€ ν¬κΈ°: 492,032 bytes
  μ΄λ―Έμ§€ ν¬κΈ°: (496, 496)
  π” μµμ  μ••μ¶•λ¥  νƒμƒ‰:
    Rate  5: JP2=49,207b, ν”½μ…€μ••μ¶•=10.0λ°°, μμƒμ „μ²΄μ••μ¶•=9.7λ°°
  β… μµμ κ°’ μ„ νƒ: Rate=5, μ••μ¶•λ¥ =9.7λ°°
  π‰ μ••μ¶• μ™„λ£: 9.7x

============================================================
π― μ μ ν• μ••μ¶• ν…μ¤νΈ κ²°κ³Ό μ”μ•½
μ„±κ³µ: 3/3κ°
ν‰κ·  μ••μ¶•λ¥ : 9.7x
μ „μ²΄ ν¬κΈ°: 1446KB β†’ 148KB

π‰ λ©ν‘ λ‹¬μ„±! μ μ ν• μ••μ¶•λ¥ λ΅ ν’μ§ λ³΄μ΅΄
```

**μ μ ν• μ••μ¶•μ νλΌλ―Έν„°:**

- `compression_rates: [2, 3, 4, 5, 6, 8, 10, 12, 15, 20]`
- λ¶„ν•΄ λ λ²¨: 5 (λ†’μ€ ν’μ§)
- μ½”λ“ λΈ”λ΅: [64,64] (ν° λΈ”λ΅μΌλ΅ ν’μ§ ν–¥μƒ)
- λΈ”λ΅ ν¬κΈ°: 64,64 (ν’μ§ μ°μ„ )
- μμ„: RPCL (ν’μ§ μ°μ„ )
- Window/Level: 600-2000 λ²”μ„ (ν’μ§ λ³΄μ΅΄ λ¨λ“)

#### β… 399κ° νμΌ μ „μ²΄ μ••μ¶• μ„±κ³µ (μµμΆ…)

```
π¥ 399κ° DICOM νμΌ ν’μ§ μ°μ„  JPEG2000 μ••μ¶• μ™„λ£
π“‚ μ…λ ¥: CT20130424_213559_8924_40274191 (399κ° νμΌ)
π“‚ μ¶λ ¥: CT20130424_213559_8924_40274191_quality (ν’μ§ λ³΄μ΅΄)
π― λ©ν‘: μλ£κΈ‰ ν’μ§ λ³΄μ΅΄ λ¨λ“

β΅ 8κ° ν”„λ΅μ„Έμ¤λ΅ λ³‘λ ¬ μ²λ¦¬ μ‹μ‘...

β… μ„±κ³µ: 399/399κ° (100% μ„±κ³µλ¥ )
β μ‹¤ν¨: 0κ°
π“ ν‰κ·  μ••μ¶•λ¥ : 8.9x (ν’μ§ μ°μ„ )
π“¦ μ΄ μ©λ‰: 196.9MB β†’ 22.4MB
π’Ύ ZIP ν¬κΈ°: 22MB (CloudWebViewer μ¤€λΉ„ μ™„λ£)
β±οΈ μ΄ μ²λ¦¬ μ‹κ°„: μ•½ 20λ¶„

π‰ ν’μ§ λ³΄μ΅΄λ μλ£ μμƒμΌλ΅ μƒμ„± μ™„λ£!
```

**μµμΆ… μ„±κ³Ό (ν’μ§ μ°μ„  λ¨λ“):**

- **ν’μ§ μ°μ„ **: 8.9λ°° μ μ ν• μ••μ¶•λ¥ λ΅ μλ£ μμƒ ν’μ§ λ³΄μ¥
- **νΈν™μ„±**: 399κ° μ¬λΌμ΄μ¤λ΅ μ™„μ „ν• 3D λ³Όλ¥¨ λ λ”λ§ μ§€μ›
- **μ•μ •μ„±**: 100% μ„±κ³µλ¥ , λ””λ ‰ν† λ¦¬ μ—†λ” κΉ¨λ—ν• ZIP κµ¬μ΅°
- **CloudWebViewer**: μ •μƒ λ΅λ”© λ° 3D λ λ”λ§ μ™„λ²½ μ§€μ›

## π† λ³΄μμ  μ†μ‹¤ μ••μ¶• μµμΆ… μ„±κ³Ό (Quality 90)

**2024.07.29 μ—…λ°μ΄νΈ:** κ°€μ¥ μ••μ¶•λ¥ μ΄ λ‚®μ€ μ†μ‹¤ μ••μ¶• κ²€μ¦ μ™„λ£

### π“ μ••μ¶• κ²°κ³Ό

```bash
π¥ μ „μ²΄ 399κ° λ³΄μμ  μ†μ‹¤ μ••μ¶• (Quality 90)
π― λ©ν‘: 2.7λ°° μµκ³  ν’μ§ μ†μ‹¤ μ••μ¶•μΌλ΅ μ „μ²΄ 3D λ³Όλ¥¨

β… μ„±κ³µ: 399/399κ° (100% μ„±κ³µλ¥ )
π“ μ „μ²΄ μ••μ¶•λ¥ : 187.8MB β†’ 69.2MB (2.7x)
π’Ύ ν‰κ·  νμΌ ν¬κΈ°: 177.6KB
β±οΈ μ²λ¦¬ μ‹κ°„: 0.1λ¶„ (λ§¤μ° λΉ λ¦„)
π’» ZIP ν¬κΈ°: 69MB (CloudWebViewer μ¤€λΉ„ μ™„λ£)
```

### π”§ κ²€μ¦λ νλΌλ―Έν„°

```bash
gdcmconv --j2k --lossy --quality 90 --irreversible input.dcm output.dcm
```

**νλΌλ―Έν„° μ„¤λ…:**

- `--j2k`: JPEG2000 μ½”λ± μ‚¬μ©
- `--lossy`: μ†μ‹¤ μ••μ¶• λ¨λ“
- `--quality 90`: 90% ν’μ§ μ μ§€ (μµκ³  μμ¤€)
- `--irreversible`: λΉ„κ°€μ—­ λ³€ν™ (λ” λ‚μ€ μ••μ¶•)

### π“ ν’μ§ λ¶„μ„

- **λ™μΌν• ν”½μ…€**: 93.0% (μ‹¤μ  μ†μ‹¤ λ°μƒ!)
- **μµλ€ μ°¨μ΄**: 2.0 (λ§¤μ° λ―Έλ―Έν• μ†μ‹¤)
- **ν‰κ·  μ°¨μ΄**: 0.07 (κ±°μ κ°μ§€ λ¶κ°€λ¥)
- **ν’μ§ λ“±κΈ‰**: μ°μ ν’μ§ (B+)
- **Transfer Syntax**: JPEG 2000 μ†μ‹¤ (1.2.840.10008.1.2.4.91)

### π― CloudWebViewer κ²€μ¦

- **β… 5κ° μƒν”**: μ •μƒ λ΅λ”© λ° μ΄λ―Έμ§€ ν’μ§ ν™•μΈ
- **β… 399κ° μ „μ²΄**: μ™„μ „ν• 3D λ³Όλ¥¨ λ λ”λ§ κ°€λ¥
- **β… λ΅λ”© μ†λ„**: μ••μ¶•μΌλ΅ μΈν• λΉ λ¥Έ λ΅λ”©
- **β… μλ£ νΈν™μ„±**: μ‹¤μ  μ†μ‹¤μ΄μ§€λ§ μ„μƒ μ‚¬μ© κ°€λ¥ν• μμ¤€

## π”§ νΈλ¬λΈ”μν…

### β οΈ μμƒ μ΄μ

1. **μ½”λ± λ΅λ”© μ‹¤ν¨**: WASM νμΌ κ²½λ΅ λ¬Έμ 
2. **μ••μ¶•λ¥  λ¶€μ΅±**: νλΌλ―Έν„° μ΅°μ • ν•„μ”
3. **νΈν™μ„± λ¬Έμ **: Transfer Syntax λλ” μΊ΅μν™” μ¤λ¥
4. **μ„±λ¥ μ΄μ**: λ€μ©λ‰ λ°°μΉ μ²λ¦¬ μµμ ν™”

### π’΅ ν•΄κ²° λ°©μ•

- λ‹¨κ³„λ³„ λ΅κ·Έ μ¶λ ¥μΌλ΅ λ¬Έμ μ  μ¶”μ 
- μ—¬λ¬ μ••μ¶• λ°©μ‹ λ³‘λ ¬ ν…μ¤νΈ
- cloudwebviewer μ—λ¬ λ©”μ‹μ§€ μƒμ„Έ λ¶„μ„
- ν•„μ”μ‹ Python μ¤ν¬λ¦½νΈ fallback μ‚¬μ©

---

**λ©ν‘**: Node.js κΈ°λ° JPEG2000 μ†μ‹¤ μ••μ¶•μΌλ΅ μλ£ μμƒ νμΌ ν¬κΈ° μµμ ν™” λ° cloudwebviewer νΈν™μ„± ν™•λ³΄
